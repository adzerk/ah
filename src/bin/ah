#!/usr/bin/env bash

AH=$(basename ${BASH_SOURCE[0]})

# Directories where ah configuration and library files are located.
AH_BIN="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
AH_LIB="$( realpath "$AH_BIN/../lib/ah" )"
AH_SHR="$( realpath "$AH_BIN/../share/ah" )"
AH_CFG="${HOME}/.ah"
AH_EXT="${AH_CFG}/extensions"

export PATH="${AH_LIB}:$PATH"

export my_pid=$$   # so subshells can kill this shell -- poor man's exceptions
trap "exit 1" USR1 # signal so exceptions can change exit status on abort

# Print an error message to stderr and exit with nonzero status.
ah_die() {
  [[ $# -gt 0 ]] && echo "$AH:" "$@" 1>&2
  kill -s USR1 $my_pid
  exit 1
}

# Load config file and export its vars.
ah_load_conf() {
  local vars=$(grep -s '^AH_[A-Z][A-Z]*=' $1 |cut -d= -f1)
  [[ -n "$vars" ]] && . $1 && export $vars
}

ah_load_conf .ah/ah.conf
ah_load_conf .ah/env

# Load AH config script

if [[ -f ${AH_CFG}/config ]]; then
  ${AH_CFG}/config > /dev/null
fi

# Bootstrapping ###############################################################

if [[ $# -gt 0 ]]; then
  AH_CMD="$1"
  AH_TRYIT=$AH_EXT/ah-${AH_CMD}/run

  if [[ -e $AH_TRYIT ]]; then
    AH_DOIT=$AH_TRYIT
  else
    AH_DOIT=$AH_LIB/ah-${AH_CMD}
  fi

  shift 1

  if [[ ! -e $AH_DOIT ]]; then
    ah_die "no such command: $AH_CMD"
  fi

  . $AH_LIB/.fns
  . $AH_DOIT
else
  ls -1 $AH_LIB |grep ^ah- |sed s/^...//
  if [[ -d $AH_EXT && $(ls -A $AH_EXT) ]]; then
    echo -e "\nExtensions:\n"
    ls -1 $AH_EXT |grep ^ah- |sed s/^...//
  fi
fi
