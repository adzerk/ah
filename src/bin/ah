#!/usr/bin/env bash

AH=$(basename ${BASH_SOURCE[0]})

# Directories where ah configuration and library files are located.
AH_BIN="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
AH_LIB="$( realpath "$AH_BIN/../lib/ah" )"
AH_SHR="$( realpath "$AH_BIN/../share/ah" )"
AH_CFG="${HOME}/.ah"
AH_EXT="${AH_CFG}/extensions"

export PATH="${AH_LIB}:$PATH"

export my_pid=$$   # so subshells can kill this shell -- poor man's exceptions
trap "exit 1" USR1 # signal so exceptions can change exit status on abort

# Print an error message to stderr and exit with nonzero status.
ah_die() {
  [[ $# -gt 0 ]] && echo "$AH:" "$@" 1>&2
  kill -s USR1 $my_pid
  exit 1
}

# Load config file and export its vars.
ah_load_conf() {
  local vars=$(grep -s '^AH_[A-Z][A-Z]*=' $1 |cut -d= -f1)
  [[ -n "$vars" ]] && . $1 && export $vars
}

ah_load_extension() {
  local sha
  local ref="${2:-master}"
  local repo="${1}"
  local name=$(echo ${1##*/} | sed 's/\.git$//')
  local to=$HOME/.ah/extensions/$name
  if [[ ! -d $to ]]; then
    echo "installing ${name} from ${repo}"
    git clone $repo $to > /dev/null 2>&1
  fi
  pushd $to > /dev/null

  sha=$(git rev-list -n1 $ref 2> /dev/null)
  if [[ $? != 0 ]]; then
    git fetch > /dev/null
    sha=$(git rev-list -n1 $ref 2> /dev/null)
    if [[ $? != 0 ]]; then ah_die "could not find ref ${ref} for extension ${name} (${repo})"; fi
  fi
  if [[ ! $sha == $(git rev-parse HEAD) ]]; then
    echo "updating extension ${name} to $ref"
    git reset --hard $sha > /dev/null
  fi
  popd > /dev/null
  export PATH="${to}:$PATH"
}

# Load AH config script

if [[ -f ${AH_CFG}/config ]]; then
  . ${AH_CFG}/config
  if [[ $? != 0 ]]; then
    ah_die "error loading config file ${AH_CFG}/config"
  fi
fi

ah_load_conf .ah/ah.conf
ah_load_conf .ah/env

# Bootstrapping ###############################################################
if [[ $# -gt 0 ]]; then
  AH_CMD="$1"
  AH_DOIT=$(which ah-$AH_CMD)
  shift 1

  if [[ ! -e $AH_DOIT ]]; then
    ah_die "no such command: $AH_CMD"
  fi

  . $AH_LIB/.fns
  . $AH_DOIT
else
  compgen -c |sort |grep ^ah- |sed s/^...//
fi
